---
title: "一般化線形モデルのシミュレーション"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

## 統計モデリングのステップ

1.データやその収集過程に関する知識に基づき、確率モデルを作る。

2.観測されたデータを条件として、モデルのパラメータや予測値等の事後確率分布を計算する。

3.データに対するモデルの当てはまりや、計算された事後確率分布の評価を行う。

```{r}
library(rstan)
library(brms)

rstan_options(auto_write = T)
options(mc.cores = parallel::detectCores())
```


## 分散分析モデル

```{r}
sales_weather <- read.csv("3-6-1-beer-sales-3.csv")
anova_brms <- brm(
  formula = sales ~ weather,  # modelの構造を指定
  family = gaussian(),        # 正規分布を使う
  data = sales_weather,       # データ
  seed = 1,                   # 乱数の種
  prior = c(set_prior("", class = "Intercept"),
            set_prior("", class = "sigma"))
)
```

>Result:

```{r}
anova_brms
```

>Plotting:

```{r}
eff <- marginal_effects(anova_brms)
plot(eff, points = FALSE)
```


## 正規線形モデル

```{r}
sales_climate <- read.csv("3-7-1-beer-sales-4.csv")
lm_brms <- brm(
  formula = sales ~ weather + temperature,  # modelの構造を指定
  family = gaussian(),                      # 正規分布を使う
  data = sales_climate,                     # データ
  seed = 1,                                 # 乱数の種
  prior = c(set_prior("", class = "Intercept"),
            set_prior("", class = "sigma"))
)
```

>Result:

```{r}
lm_brms
```

>Plotting:

```{r}
eff <- marginal_effects(lm_brms, effects = "temperature:weather")
plot(eff, points = TRUE)
```


## ポアソン回帰モデル

```{r}
fish_num_climate <- read.csv("3-8-1-fish-num-1.csv")
glm_pois_brms <- brm(
  formula = fish_num ~ weather + temperature,  # modelの構造を指定
  family = poisson(),                          # ポアソン分布を使う
  data = fish_num_climate,                     # データ
  seed = 1,                                    # 乱数の種
  prior = c(set_prior("", class = "Intercept"))# 無情報事前分布にする
)
```

>Result:

```{r}
glm_pois_brms
```

>Plotting:

```{r}
eff <- marginal_effects(glm_pois_brms, 
                        effects = "temperature:weather")
plot(eff, points = TRUE)
```

>Posterior distribution:

```{r}
plot(glm_pois_brms)
```


ポアソン回帰モデルが過分散となる場合には、ランダム効果をを入れた一般化線形混合モデルとして扱う。

```{r}
fish_num_climate_2 <- read.csv("4-1-1-fish-num-2.csv")
fish_num_climate_2$id <- as.factor(fish_num_climate_2$id)
glmm_pois_brms <- brm(
  formula = fish_num ~ weather + temperature + (1|id), # ランダム効果
  family = poisson(),                            # ポアソン分布を使う
  data = fish_num_climate_2,                     # データ
  seed = 1,                                      # 乱数の種
  prior = c(set_prior("", class = "Intercept"),
            set_prior("", class = "sd"))         # 無情報事前分布にする
)
```

>Result:

```{r}
glmm_pois_brms
```

>Plotting:

```{r}
eff <- marginal_effects(glmm_pois_brms, 
                        effects = "temperature:weather")
plot(eff, points = TRUE)
```

>Posterior distribution:

```{r}
plot(glmm_pois_brms)
```


## ロジスティック回帰モデル

```{r}
germination_dat <- read.csv("3-9-1-germination.csv")
glm_binom_brms <- brm(
  germination | trials(size) ~ solar + nutrition, # modelの構造を指定
  family = binomial(),                         # 二項分布を使う
  data = germination_dat,                      # データ
  seed = 1,                                    # 乱数の種
  prior = c(set_prior("", class = "Intercept"))# 無情報事前分布にする
)
```

>Result:

```{r}
glm_binom_brms
```

>Plotting:

```{r}
eff <- marginal_effects(glm_binom_brms, 
                        effects = "nutrition:solar",
                        conditions = data.frame(size = 10))
plot(eff, points = TRUE)
```

>Posterior distribution:

```{r}
plot(glm_binom_brms)
```


Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
